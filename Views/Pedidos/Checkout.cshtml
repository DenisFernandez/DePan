@model DePan.Models.CheckoutViewModel

@{
    ViewData["Title"] = "Finalizar Compra";
}

<div class="container">
    <h1 class="mb-4">Finalizar Compra</h1>

    <!-- Área de mensajes -->
    <div id="mensaje-checkout" style="display: none;"></div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información de Envío</h5>
                </div>
                <div class="card-body">
                    <form id="formCheckout" asp-action="Checkout" method="post">
                        @Html.AntiForgeryToken()
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="DireccionEntrega" class="form-label">Dirección de Entrega *</label>
                                <input asp-for="DireccionEntrega" class="form-control" />
                                <span asp-validation-for="DireccionEntrega" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CiudadEntrega" class="form-label">Ciudad *</label>
                                <input asp-for="CiudadEntrega" class="form-control" placeholder="Ej: Madrid" />
                                <span asp-validation-for="CiudadEntrega" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CodigoPostalEntrega" class="form-label">Código Postal * <small class="text-muted">(5 dígitos)</small></label>
                                <input asp-for="CodigoPostalEntrega" class="form-control" placeholder="Ej: 28001" 
                                       pattern="^\d{5}$" title="El código postal debe tener exactamente 5 dígitos"
                                       required />
                                <span asp-validation-for="CodigoPostalEntrega" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">Formato: 5 dígitos numéricos</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="TelefonoContacto" class="form-label">Teléfono de Contacto * <small class="text-muted">(9 dígitos)</small></label>
                                <input asp-for="TelefonoContacto" class="form-control" placeholder="Ej: 612345678" 
                                       pattern="^\d{9}$" title="El teléfono debe tener exactamente 9 dígitos"
                                       required />
                                <span asp-validation-for="TelefonoContacto" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">Formato: 9 dígitos numéricos</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notas" class="form-label">Notas Adicionales (Opcional)</label>
                            <textarea asp-for="Notas" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Notas" class="text-danger"></span>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="aceptoTerminos" required>
                            <label class="form-check-label" for="aceptoTerminos">
                                Acepto los términos y condiciones
                            </label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" id="btnConfirmar" class="btn btn-success btn-lg">
                                <span id="btnText">
                                    <i class="fas fa-check-circle"></i> Confirmar Pedido
                                </span>
                                <span id="btnSpinner" style="display: none;">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Procesando...
                                </span>
                            </button>
                            <a href="@Url.Action("Index", "Carrito")" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Volver al Carrito
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Resumen del Pedido</h5>
                </div>
                <div class="card-body">
                    @if (Model.Carrito != null)
                    {
                        foreach (var linea in Model.Carrito.LineaCarritos)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <small>@linea.IdProductoNavigation.Nombre</small>
                                    <br>
                                    <small class="text-muted">@linea.Cantidad x @linea.PrecioUnitario.ToString("C")</small>
                                </div>
                                <small>@linea.Subtotal.ToString("C")</small>
                            </div>
                        }
                        
                        <hr>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Subtotal:</span>
                            <span>@Model.Carrito.Total.ToString("C")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Envío:</span>
                            <span>2,50 €</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total:</span>
                            <span>@((Model.Carrito.Total + 2.50m).ToString("C"))</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('formCheckout').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Obtener valores de los campos usando los atributos name
            const codigoPostal = document.querySelector('input[name="CodigoPostalEntrega"]').value.trim();
            const telefono = document.querySelector('input[name="TelefonoContacto"]').value.trim();
            const ciudad = document.querySelector('input[name="CiudadEntrega"]').value.trim();
            const direccion = document.querySelector('input[name="DireccionEntrega"]').value.trim();
            
            // Validar Código Postal (5 dígitos numéricos)
            if (!/^\d{5}$/.test(codigoPostal)) {
                mostrarMensaje('El código postal debe contener exactamente 5 dígitos numéricos. Ej: 28001', 'warning');
                return;
            }
            
            // Validar Teléfono (9 dígitos numéricos)
            if (!/^\d{9}$/.test(telefono)) {
                mostrarMensaje('El teléfono debe contener exactamente 9 dígitos numéricos. Ej: 612345678', 'warning');
                return;
            }
            
            // Validar que no haya números en la ciudad
            if (/\d/.test(ciudad)) {
                mostrarMensaje('La ciudad no puede contener números', 'warning');
                return;
            }
            
            // Validar que la ciudad no esté vacía
            if (ciudad.length === 0) {
                mostrarMensaje('Por favor, ingresa una ciudad válida', 'warning');
                return;
            }
            
            // Validar que la dirección no esté vacía
            if (direccion.length === 0) {
                mostrarMensaje('Por favor, ingresa una dirección válida', 'warning');
                return;
            }
            
            // Validar términos
            if (!document.getElementById('aceptoTerminos').checked) {
                mostrarMensaje('Debes aceptar los términos y condiciones para continuar', 'warning');
                return;
            }

            // Deshabilitar botón y mostrar spinner
            const btnConfirmar = document.getElementById('btnConfirmar');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            btnConfirmar.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';

            try {
                const formData = new FormData(this);
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    // Si hubo redirección, el pedido se creó exitosamente
                    mostrarMensaje('¡Tu pedido ha sido recibido con éxito! Redirigiendo...', 'success');
                    setTimeout(() => {
                        window.location.href = response.url;
                    }, 2000);
                } else if (response.ok) {
                    // Verificar si hay redirección en el HTML
                    const html = await response.text();
                    if (html.includes('Pedido Confirmado') || html.includes('Confirmacion')) {
                        mostrarMensaje('¡Tu pedido ha sido recibido con éxito! Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("MisPedidos", "Pedidos")';
                        }, 2000);
                    } else {
                        // Hubo un error en el formulario
                        mostrarMensaje('Por favor, verifica que todos los campos estén correctamente completados.', 'danger');
                        btnConfirmar.disabled = false;
                        btnText.style.display = 'inline-block';
                        btnSpinner.style.display = 'none';
                    }
                } else {
                    throw new Error('Error en el servidor');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('Hubo un problema al procesar tu pedido. Por favor, inténtalo de nuevo o contacta con soporte.', 'danger');
                
                // Rehabilitar botón
                btnConfirmar.disabled = false;
                btnText.style.display = 'inline-block';
                btnSpinner.style.display = 'none';
            }
        });

        function mostrarMensaje(texto, tipo) {
            const mensajeDiv = document.getElementById('mensaje-checkout');
            
            let icono = '';
            switch(tipo) {
                case 'success':
                    icono = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'danger':
                    icono = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    icono = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                    icono = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            mensajeDiv.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${icono} ${texto}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            mensajeDiv.style.display = 'block';
            
            // Scroll suave hacia el mensaje
            mensajeDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-ocultar después de 5 segundos (excepto errores)
            if (tipo !== 'danger') {
                setTimeout(() => {
                    const alert = mensajeDiv.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => {
                            mensajeDiv.style.display = 'none';
                        }, 150);
                    }
                }, 5000);
            }
        }
        
        // Validación en tiempo real para Código Postal
        document.querySelector('input[name="CodigoPostalEntrega"]').addEventListener('input', function(e) {
            // Permitir solo números
            this.value = this.value.replace(/[^\d]/g, '');
            // Limitar a 5 caracteres
            if (this.value.length > 5) {
                this.value = this.value.slice(0, 5);
            }
        });
        
        // Validación en tiempo real para Teléfono
        document.querySelector('input[name="TelefonoContacto"]').addEventListener('input', function(e) {
            // Permitir solo números
            this.value = this.value.replace(/[^\d]/g, '');
            // Limitar a 9 caracteres
            if (this.value.length > 9) {
                this.value = this.value.slice(0, 9);
            }
        });
        
        // Validación en tiempo real para Ciudad
        document.querySelector('input[name="CiudadEntrega"]').addEventListener('input', function(e) {
            // Eliminar números
            this.value = this.value.replace(/\d/g, '');
        });
    </script>
}